
# AGENTS.md — Pengu Profiles & Pengufile Migration

## Role
You are an advanced software engineering agent tasked with evolving the **Pengu** project.
You will modify the existing Bash and PowerShell helper scripts and installers to support
**profile-based Pengu environments**, while avoiding conflicts with project-level Dockerfiles.

You must design and implement this change cleanly, incrementally, and without breaking
existing users.

---

## Context

Pengu currently:

- Assumes a `Dockerfile` in the project root
- Builds a single container/image per project
- Uses fixed naming for container and volumes
- Installs its build definition directly into the project root

This causes two structural problems:

1. **Name collision** with projects that already use `Dockerfile`
2. **No way to support multiple Pengu environments ("profiles") per project**

---

## Target Design (Required)

### 1. Introduce `.pengu/` as Pengu’s configuration root

Pengu must no longer rely on `Dockerfile` in the project root.

Instead, Pengu configuration lives in:

```

.pengu/
├── Pengufile
├── Pengufile.<profile>

```

Examples:
- `.pengu/Pengufile` → default Pengu environment
- `.pengu/Pengufile.java`
- `.pengu/Pengufile.node`
- `.pengu/Pengufile.docs`

A `Pengufile` is a standard Dockerfile, unmodified in syntax.

---

### 2. Profile semantics

Pengu commands accept an optional profile name:

```

./pengu up
./pengu up java
./pengu shell node
./pengu rebuild docs

```

Rules:
- If no profile is given → profile = `default`
- `default` maps to `.pengu/Pengufile`
- A named profile maps to `.pengu/Pengufile.<profile>`

If the required file does not exist, fail with a clear error message.

---

### 3. Isolation rules (critical)

Profiles must be **fully isolated**.

Each profile must have:
- its own image
- its own container
- its own volumes

Naming scheme (deterministic):

```

Project name: basename($PWD)

Profile: default | <profile>

Image:      pengu:<project>-<profile>
Container:  <project>-pengu-<profile>

Volumes: <project>-pengu-<profile>-home <project>-pengu-<profile>-apt <project>-pengu-<profile>-lists

```

This prevents cross-profile contamination.

---

### 4. Build behavior

When running `./pengu up [profile]`:

- Select the correct Pengufile
- Build using:
  - `docker build -f .pengu/Pengufile[.<profile>]`
  - or `podman build -f .pengu/Pengufile[.<profile>]`
- Tag image according to naming scheme above
- Create container only if it does not exist
- Reuse existing container if present

---

### 5. Backward compatibility (important)

To avoid breaking existing users:

If `.pengu/Pengufile` does **not** exist:
- If `Dockerfile` exists in project root:
  - Use it as a fallback
  - Emit a warning:
    ```
    WARNING: Using Dockerfile is deprecated.
    Please migrate to .pengu/Pengufile.
    ```
- Otherwise, fail with a clear error.

Installers should **no longer install `Dockerfile`**.

---

### 6. Installer changes

Both installers must:

#### Bash installer (`pengu-install.sh`)
- Create `.pengu/`
- Install `.pengu/Pengufile` (default)
- Install `pengu` (bash helper)

#### PowerShell installer (`pengu-install.ps1`)
- Create `.pengu/`
- Install `.pengu/Pengufile`
- Install `pengu.ps1`
- Optionally also install `pengu` (bash helper) for Git Bash users

Installers must **not** touch or overwrite an existing `Dockerfile`.

---

### 7. Helper scripts to update

You must update:

- `pengu` (bash)
- `pengu.ps1` (PowerShell)

Required changes:
- Parse optional profile argument
- Resolve Pengufile path
- Compute profile-specific names
- Use `-f` to point to the correct Pengufile
- Preserve existing commands (`up`, `shell`, `root`, `stop`, `rm`, `rebuild`, `commit`, `nuke`)

---

### 8. Non-goals (explicitly do NOT do)

- Do not introduce docker-compose
- Do not introduce YAML config
- Do not add dependency on IDE tooling
- Do not break existing commands
- Do not auto-generate profiles beyond `default`

---

## Deliverables

1. Updated `pengu` (bash) script
2. Updated `pengu.ps1` script
3. Updated `pengu-install.sh`
4. Updated `pengu-install.ps1`
5. Minimal README delta (instructions for profiles + `.pengu/`)

Each change should be deliberate and minimal.

---

## Quality bar

The result should:

- Feel like a natural evolution of Pengu
- Preserve its “drop-in, zero-config” philosophy
- Scale cleanly to multiple profiles per project
- Avoid conceptual or naming collisions with the host project

If trade-offs exist, prefer:
**clarity > cleverness**,  
**predictability > magic**,  
**isolation > convenience**.
